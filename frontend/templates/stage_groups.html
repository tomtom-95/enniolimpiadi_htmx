<div id="stage-groups-content">
    {% if stage.total_participants >= 2 %}
        {% set num_groups = stage.groups | length %}
        <div class="group-resize-bar">
            <span class="group-resize-label">Numero di gironi:</span>
            <div class="group-resize-controls">
                {% if num_groups > 1 %}
                    <button hx-post="/api/events/{{ event_id }}/stages/{{ stage.id }}/resize"
                        hx-vals='{"num_groups": {{ num_groups - 1 }}}'
                        hx-target="#stage-groups-content" hx-swap="outerHTML"
                        class="group-resize-btn">&minus;</button>
                {% else %}
                    <button class="group-resize-btn" disabled>&minus;</button>
                {% endif %}
                <span class="group-resize-value">{{ num_groups }}</span>
                {% if num_groups < stage.total_participants // 2 %}
                    <button hx-post="/api/events/{{ event_id }}/stages/{{ stage.id }}/resize"
                        hx-vals='{"num_groups": {{ num_groups + 1 }}}'
                        hx-target="#stage-groups-content" hx-swap="outerHTML"
                        class="group-resize-btn">&plus;</button>
                {% else %}
                    <button class="group-resize-btn" disabled>&plus;</button>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <div class="stage-groups">
    {% for group in stage.groups %}
        <div class="group-card">
            <div class="group-header" _="on click toggle .collapsed on closest .group-card">
                <h4>{{ group.name }}</h4>
                <span class="group-toggle">&#9662;</span>
            </div>
            {% set ps = group.participants %}
            {% set n = ps | length %}
            <div class="group-grid-wrap">
                <div class="grid-row-labels">
                    <div class="grid-col-header-spacer"></div>
                    {% for i in range(0, n) %}
                        <div class="grid-row-header">{{ ps[i] }}</div>
                    {% endfor %}
                </div>
                <div class="grid-scroll">
                    <div class="grid-scores" style="grid-template-columns: repeat({{ n }}, 1fr);">
                        {% for j in range(0, n) %}
                            <div class="grid-col-header">{{ ps[j] }}</div>
                        {% endfor %}
                        {% for i in range(0, n) %}
                            {% for j in range(0, n) %}
                                {% if i == j %}
                                    <div class="grid-cell self">&#10005;</div>
                                {% elif j > i %}
                                    {% set score = group.scores.get(ps[i], {}).get(ps[j]) %}
                                        {% if score %}
                                            <div class="grid-cell has-score">{{ score }}</div>
                                        {% else %}
                                            <div class="grid-cell">-</div>
                                        {% endif %}
                                {% else %}
                                    <div class="grid-cell empty"></div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
    </div>
</div>
