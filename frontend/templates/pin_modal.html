<div class="modal-overlay" _="on click if event.target is me remove me end on closeModal from body remove me">
    <div class="modal-content">
        <h3>Inserisci PIN</h3>
        {% if error %}
            <div class="error-banner">{{ error }}</div>
        {% endif %}
        <form hx-post="{{ action }}" hx-target="#modal-container">
            {% if name %}<input type="hidden" name="name" value="{{ name }}">{% endif %}
            {% if olympiad_id %}<input type="hidden" name="olympiad_id" value="{{ olympiad_id }}">{% endif %}
            <input type="hidden" name="pin" id="pin-hidden" value="{{ pin | default('') }}">
            <div class="pin-input-container">
                <input type="text" inputmode="numeric" maxlength="1" class="pin-digit" autofocus>
                <input type="text" inputmode="numeric" maxlength="1" class="pin-digit">
                <input type="text" inputmode="numeric" maxlength="1" class="pin-digit">
                <input type="text" inputmode="numeric" maxlength="1" class="pin-digit">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" _="on click remove closest .modal-overlay">Annulla</button>
                <button type="submit" class="btn-submit">{{ submit_text | default("Conferma") }}</button>
            </div>
        </form>
        <script>
            (function() {
                const script = document.currentScript;
                const modal = script.closest('.modal-content');

                function initPinInputs() {
                    const digits = modal.querySelectorAll('.pin-digit');
                    const hidden = modal.querySelector('#pin-hidden');

                    function updateHidden() {
                        hidden.value = Array.from(digits).map(d => d.value).join('');
                    }

                    digits.forEach((input, idx) => {
                        input.addEventListener('input', (e) => {
                            const val = e.target.value.replace(/\D/g, '');
                            e.target.value = val.slice(-1);
                            updateHidden();
                            if (val && idx < 3) {
                                digits[idx + 1].focus();
                            }
                        });

                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Backspace' && !e.target.value && idx > 0) {
                                digits[idx - 1].focus();
                            }
                        });
                    });
                }

                document.body.addEventListener('htmx:afterSettle', initPinInputs, { once: true });
            })();
        </script>
    </div>
</div>
